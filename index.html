<!DOCTYPE html>
<html>
<head>
    <title>Face Perception Study</title>
    <script src="https://unpkg.com/jspsych@7.3.4"></script>
    <script src="https://unpkg.com/@jspsych/plugin-html-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-image-keyboard-response@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-preload@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-text@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-survey-multi-choice@1.1.3"></script>
    <script src="https://unpkg.com/@jspsych/plugin-fullscreen@1.2.1"></script>
    <link href="https://unpkg.com/jspsych@7.3.4/css/jspsych.css" rel="stylesheet" type="text/css" />
    <style>
        .jspsych-content {
            max-width: 900px;
        }
        .stimulus-image {
            max-height: 500px;
            max-width: 700px;
        }
        .key-reminder {
            font-size: 18px;
            margin-top: 20px;
        }
        .left-key {
            color: #2196F3;
            font-weight: bold;
        }
        .right-key {
            color: #4CAF50;
            font-weight: bold;
        }
        .instructions {
            text-align: left;
            max-width: 800px;
            margin: 0 auto;
            line-height: 1.6;
        }
        .feedback-correct {
            color: #4CAF50;
            font-size: 48px;
            font-weight: bold;
        }
        .feedback-incorrect {
            color: #f44336;
            font-size: 48px;
            font-weight: bold;
        }
    </style>
</head>
<body></body>
<script>
    /* ==========================================
       CONFIGURATION - EDIT THESE VALUES
       ========================================== */
    
    // Counterbalancing: set to 1 or 2 to counterbalance key assignments across participants
    // Version 1: Left = Western, Right = Chinese
    // Version 2: Left = Chinese, Right = Western
    // You can randomize this in Cognition.run by using URL parameters
    const VERSION = new URLSearchParams(window.location.search).get('version') || Math.random() < 0.5 ? 1 : 2;
    
    // Key assignments based on version
    const KEY_CONFIG = VERSION == 1 ? {
        western_key: 'arrowleft',
        chinese_key: 'arrowright',
        western_label: '← Left Arrow',
        chinese_label: 'Right Arrow →'
    } : {
        western_key: 'arrowright',
        chinese_key: 'arrowleft',
        western_label: 'Right Arrow →',
        chinese_label: '← Left Arrow'
    };

    /* ==========================================
       INITIALIZE JSPSYCH
       ========================================== */
    
    const jsPsych = initJsPsych({
        on_finish: function() {
            // For Cognition.run, data is automatically saved
            // For local testing, you can download data
            if (typeof jatos !== 'undefined') {
                jatos.submitResultData(jsPsych.data.get().json());
            } else {
                jsPsych.data.get().localSave('csv', 'cultural_face_data.csv');
            }
        },
        show_progress_bar: true
    });

    /* ==========================================
       STIMULI - LOADED FROM EXTERNAL JSON
       ========================================== */
    
    // Stimuli will be loaded from stimuli.json
    // Format: [{image: "path/to/image.jpg", source: "western" or "chinese"}, ...]
    let all_stimuli = [];
    let practice_stimuli = [];
    let main_stimuli = [];

    /* ==========================================
       TIMELINE COMPONENTS
       ========================================== */
    
    // Welcome screen
    const welcome = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: `
            <h1>Welcome to the Face Perception Study</h1>
            <p>Thank you for participating in this research.</p>
            <p>This study examines how people perceive faces from different cultural contexts.</p>
            <p>The study will take approximately <strong>15-20 minutes</strong> to complete.</p>
            <br>
            <p>Press <strong>SPACE</strong> to continue.</p>
        `,
        choices: [' ']
    };

    // Enter fullscreen
    const fullscreen = {
        type: jsPsychFullscreen,
        fullscreen_mode: true,
        message: `
            <p>The experiment will switch to fullscreen mode when you press the button below.</p>
            <p>Please remain in fullscreen for the duration of the study.</p>
        `
    };

    // Instructions
    const instructions = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            return `
                <div class="instructions">
                    <h2>Instructions</h2>
                    <p>In this study, you will see photographs of faces one at a time.</p>
                    <p>Each face was sourced from either a <strong>Western</strong> (Google Images) or <strong>Chinese</strong> (Baidu) search engine.</p>
                    <p>Your task is to judge which cultural context each image most likely came from.</p>
                    <br>
                    <h3>Response Keys:</h3>
                    <p><span class="left-key">${KEY_CONFIG.western_label}</span> = Western (Google)</p>
                    <p><span class="right-key">${KEY_CONFIG.chinese_label}</span> = Chinese (Baidu)</p>
                    <br>
                    <p>Please respond as <strong>quickly and accurately</strong> as possible.</p>
                    <p>There are no right or wrong answers - we are interested in your intuitions.</p>
                    <br>
                    <p>We will start with a few <strong>practice trials</strong>.</p>
                    <br>
                    <p>Press <strong>SPACE</strong> to begin the practice.</p>
                </div>
            `;
        },
        choices: [' ']
    };

    // Fixation cross
    const fixation = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: '<p style="font-size: 48px;">+</p>',
        choices: "NO_KEYS",
        trial_duration: 500
    };

    // Practice trial
    const practice_trial = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('image'),
        stimulus_height: 450,
        choices: ['arrowleft', 'arrowright'],
        prompt: function() {
            return `
                <div class="key-reminder">
                    <span class="left-key">${KEY_CONFIG.western_label}</span> = Western &nbsp;&nbsp;&nbsp;&nbsp;
                    <span class="right-key">${KEY_CONFIG.chinese_label}</span> = Chinese
                </div>
            `;
        },
        data: {
            task: 'practice',
            source: jsPsych.timelineVariable('source'),
            correct_key: function() {
                const source = jsPsych.evaluateTimelineVariable('source');
                return source === 'western' ? KEY_CONFIG.western_key : KEY_CONFIG.chinese_key;
            }
        },
        on_finish: function(data) {
            data.correct = data.response === data.correct_key;
            data.response_label = data.response === KEY_CONFIG.western_key ? 'western' : 'chinese';
        }
    };

    // Practice feedback
    const practice_feedback = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            const last_trial = jsPsych.data.get().last(1).values()[0];
            if (last_trial.correct) {
                return '<p class="feedback-correct">✓ Correct</p>';
            } else {
                return '<p class="feedback-incorrect">✗ Incorrect</p>';
            }
        },
        choices: "NO_KEYS",
        trial_duration: 800
    };

    // Practice procedure
    const practice_procedure = {
        timeline: [fixation, practice_trial, practice_feedback],
        timeline_variables: [], // Will be set after loading stimuli
        randomize_order: true
    };

    // End of practice
    const end_practice = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            const practice_data = jsPsych.data.get().filter({task: 'practice'});
            const accuracy = Math.round(practice_data.select('correct').mean() * 100);
            return `
                <h2>End of Practice</h2>
                <p>You got <strong>${accuracy}%</strong> correct.</p>
                <br>
                <p>Remember:</p>
                <p><span class="left-key">${KEY_CONFIG.western_label}</span> = Western (Google)</p>
                <p><span class="right-key">${KEY_CONFIG.chinese_label}</span> = Chinese (Baidu)</p>
                <br>
                <p>The main task will now begin. There will be no feedback during the main task.</p>
                <p>Press <strong>SPACE</strong> to start.</p>
            `;
        },
        choices: [' ']
    };

    // Main trial
    const main_trial = {
        type: jsPsychImageKeyboardResponse,
        stimulus: jsPsych.timelineVariable('image'),
        stimulus_height: 450,
        choices: ['arrowleft', 'arrowright'],
        prompt: function() {
            return `
                <div class="key-reminder">
                    <span class="left-key">${KEY_CONFIG.western_label}</span> = Western &nbsp;&nbsp;&nbsp;&nbsp;
                    <span class="right-key">${KEY_CONFIG.chinese_label}</span> = Chinese
                </div>
            `;
        },
        data: {
            task: 'main',
            source: jsPsych.timelineVariable('source'),
            image_id: jsPsych.timelineVariable('image_id'),
            correct_key: function() {
                const source = jsPsych.evaluateTimelineVariable('source');
                return source === 'western' ? KEY_CONFIG.western_key : KEY_CONFIG.chinese_key;
            }
        },
        on_finish: function(data) {
            data.correct = data.response === data.correct_key;
            data.response_label = data.response === KEY_CONFIG.western_key ? 'western' : 'chinese';
            data.version = VERSION;
        }
    };

    // Main procedure with breaks
    const main_procedure = {
        timeline: [fixation, main_trial],
        timeline_variables: [], // Will be set after loading stimuli
        randomize_order: true
    };

    // Break screen (inserted every N trials)
    const break_screen = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            const trials_done = jsPsych.data.get().filter({task: 'main'}).count();
            const total_trials = main_stimuli.length;
            const percent_done = Math.round((trials_done / total_trials) * 100);
            return `
                <h2>Break</h2>
                <p>You have completed <strong>${percent_done}%</strong> of the main task.</p>
                <p>Take a short break if needed.</p>
                <br>
                <p>Press <strong>SPACE</strong> to continue.</p>
            `;
        },
        choices: [' ']
    };

    // Debrief questionnaire
    const debrief_strategy = {
        type: jsPsychSurveyText,
        questions: [
            {
                prompt: 'What cues or features did you use to make your judgments?',
                name: 'strategy',
                rows: 4,
                required: true
            },
            {
                prompt: 'Did you notice any patterns that helped distinguish Western from Chinese images?',
                name: 'patterns',
                rows: 4,
                required: false
            }
        ],
        preamble: '<h2>Brief Questions</h2><p>Please answer the following questions about your experience:</p>'
    };

    const debrief_demographics = {
        type: jsPsychSurveyMultiChoice,
        questions: [
            {
                prompt: 'What is your cultural background?',
                name: 'cultural_background',
                options: ['Western/European', 'East Asian', 'South Asian', 'Southeast Asian', 'Middle Eastern', 'African', 'Latin American', 'Mixed/Other'],
                required: true
            },
            {
                prompt: 'Have you spent significant time (>6 months) in China or other East Asian countries?',
                name: 'east_asia_experience',
                options: ['Yes', 'No'],
                required: true
            }
        ]
    };

    // End screen
    const end_screen = {
        type: jsPsychHtmlKeyboardResponse,
        stimulus: function() {
            const main_data = jsPsych.data.get().filter({task: 'main'});
            const accuracy = Math.round(main_data.select('correct').mean() * 100);
            const mean_rt = Math.round(main_data.select('rt').mean());
            return `
                <h1>Thank You!</h1>
                <p>You have completed the study.</p>
                <br>
                <h3>Your Performance:</h3>
                <p>Accuracy: <strong>${accuracy}%</strong></p>
                <p>Average response time: <strong>${mean_rt} ms</strong></p>
                <br>
                <p>Your data has been saved.</p>
                <p>You may now close this window.</p>
            `;
        },
        choices: "NO_KEYS"
    };

    /* ==========================================
       LOAD STIMULI AND RUN EXPERIMENT
       ========================================== */
    
    // Load stimuli from JSON file
    fetch('stimuli.json')
        .then(response => response.json())
        .then(data => {
            all_stimuli = data.stimuli;
            
            // Separate practice and main stimuli
            practice_stimuli = all_stimuli.filter(s => s.is_practice);
            main_stimuli = all_stimuli.filter(s => !s.is_practice);
            
            // If no practice stimuli marked, take first 6 (3 per category)
            if (practice_stimuli.length === 0) {
                const western = all_stimuli.filter(s => s.source === 'western').slice(0, 3);
                const chinese = all_stimuli.filter(s => s.source === 'chinese').slice(0, 3);
                practice_stimuli = [...western, ...chinese];
                main_stimuli = all_stimuli.filter(s => !practice_stimuli.includes(s));
            }
            
            // Set timeline variables
            practice_procedure.timeline_variables = practice_stimuli;
            main_procedure.timeline_variables = main_stimuli;
            
            // Get all image paths for preloading
            const all_images = all_stimuli.map(s => s.image);
            
            // Preload images
            const preload = {
                type: jsPsychPreload,
                images: all_images,
                show_progress_bar: true,
                message: 'Loading images, please wait...'
            };
            
            // Build timeline with breaks every 50 trials
            let timeline = [
                preload,
                welcome,
                fullscreen,
                instructions,
                practice_procedure,
                end_practice
            ];
            
            // Add main trials with breaks
            const BREAK_INTERVAL = 50;
            const num_breaks = Math.floor(main_stimuli.length / BREAK_INTERVAL);
            
            // For simplicity, we'll use conditional breaks based on trial count
            // The main_procedure handles all trials, and we add break checks
            const main_with_breaks = {
                timeline: [fixation, main_trial],
                timeline_variables: main_stimuli,
                randomize_order: true,
                on_timeline_finish: function() {
                    // Check if we need a break
                    const trials_done = jsPsych.data.get().filter({task: 'main'}).count();
                    if (trials_done % BREAK_INTERVAL === 0 && trials_done < main_stimuli.length) {
                        // This won't work directly - breaks need different approach
                    }
                }
            };
            
            timeline.push(main_with_breaks);
            timeline.push(debrief_strategy);
            timeline.push(debrief_demographics);
            timeline.push(end_screen);
            
            // Run the experiment
            jsPsych.run(timeline);
        })
        .catch(error => {
            console.error('Error loading stimuli:', error);
            document.body.innerHTML = `
                <div style="padding: 50px; text-align: center;">
                    <h1>Error Loading Experiment</h1>
                    <p>Could not load stimuli.json. Please ensure the file exists and is properly formatted.</p>
                    <p>Error: ${error.message}</p>
                </div>
            `;
        });
</script>
</html>
